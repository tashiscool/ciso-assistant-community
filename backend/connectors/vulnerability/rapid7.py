"""
Rapid7 InsightVM/Nexpose Connector.

Provides vulnerability management and scanning capabilities.
"""

from dataclasses import dataclass, field
from typing import Any, List, Optional
import logging
import httpx
import base64

from ..base.connector import (
    BaseConnector, ConnectorCategory, ConnectorConfig, ConnectorResult, AuthenticationError
)
from ..base.registry import ConnectorRegistry

logger = logging.getLogger(__name__)


@dataclass
class Rapid7Vulnerability:
    """Represents a Rapid7 vulnerability finding."""
    id: str
    title: str
    severity: str
    cvss_score: Optional[float]
    risk_score: float
    asset_id: str
    asset_name: str
    asset_ip: Optional[str]
    status: str
    solution_id: Optional[str] = None
    cve_ids: List[str] = field(default_factory=list)
    exploits: int = 0
    malware_kits: int = 0
    description: Optional[str] = None
    solution: Optional[str] = None
    first_found: Optional[str] = None
    last_found: Optional[str] = None


@ConnectorRegistry.register
class Rapid7Connector(BaseConnector[Rapid7Vulnerability]):
    """Connector for Rapid7 InsightVM/Nexpose."""

    connector_type = "rapid7"
    display_name = "Rapid7 InsightVM"
    description = "Enterprise vulnerability management platform"
    category = ConnectorCategory.VULNERABILITY
    supported_auth_types = ["api_key", "basic"]
    supports_sync = True
    supports_webhook = True

    def __init__(self, config: ConnectorConfig):
        super().__init__(config)
        self._auth_header: Optional[str] = None

    async def validate_config(self) -> ConnectorResult:
        if not self.config.base_url:
            return ConnectorResult(success=False, error_message="Console URL required", error_code="MISSING_CONFIG")
        if not self.config.credentials.get("api_key") and not (
            self.config.credentials.get("username") and self.config.credentials.get("password")
        ):
            return ConnectorResult(success=False, error_message="API key or username/password required", error_code="MISSING_CREDENTIALS")
        return ConnectorResult(success=True)

    async def test_connection(self) -> ConnectorResult:
        try:
            await self.authenticate()
            async with httpx.AsyncClient(verify=False) as client:
                response = await client.get(
                    f"{self.config.base_url}/api/3/administration/info",
                    headers={"Authorization": self._auth_header},
                    timeout=self.config.timeout_seconds
                )
                if response.status_code == 200:
                    return ConnectorResult(success=True)
            return ConnectorResult(success=False, error_message="API connection failed", error_code="CONNECTION_ERROR")
        except Exception as e:
            return ConnectorResult(success=False, error_message=str(e), error_code="CONNECTION_ERROR")

    async def authenticate(self) -> ConnectorResult:
        if self.config.credentials.get("api_key"):
            self._auth_header = f"nexposecredential:{self.config.credentials['api_key']}"
        else:
            creds = f"{self.config.credentials['username']}:{self.config.credentials['password']}"
            self._auth_header = f"Basic {base64.b64encode(creds.encode()).decode()}"
        return ConnectorResult(success=True)

    async def fetch_data(self, **kwargs) -> ConnectorResult:
        if not self._auth_header:
            return ConnectorResult(success=False, error_message="Not authenticated", error_code="NOT_AUTHENTICATED")

        all_vulns = []
        try:
            async with httpx.AsyncClient(verify=False) as client:
                page = 0
                while True:
                    response = await client.get(
                        f"{self.config.base_url}/api/3/vulnerabilities",
                        headers={"Authorization": self._auth_header},
                        params={"page": page, "size": 100},
                        timeout=self.config.timeout_seconds
                    )
                    if response.status_code != 200:
                        break
                    data = response.json()
                    vulns = data.get("resources", [])
                    all_vulns.extend(vulns)
                    if len(vulns) < 100 or len(all_vulns) >= kwargs.get("max_results", 5000):
                        break
                    page += 1

            return ConnectorResult(success=True, data=all_vulns, items_processed=len(all_vulns))
        except Exception as e:
            return ConnectorResult(success=False, error_message=str(e), error_code="FETCH_ERROR")

    async def transform_data(self, raw_data: Any) -> List[Rapid7Vulnerability]:
        vulns = []
        for v in raw_data:
            vulns.append(Rapid7Vulnerability(
                id=v.get("id", ""),
                title=v.get("title", ""),
                severity=v.get("severity", ""),
                cvss_score=v.get("cvss", {}).get("v3", {}).get("score") or v.get("cvss", {}).get("v2", {}).get("score"),
                risk_score=v.get("riskScore", 0),
                asset_id="",
                asset_name="",
                asset_ip=None,
                status="vulnerable",
                cve_ids=v.get("cves", []),
                exploits=v.get("exploits", 0),
                malware_kits=v.get("malwareKits", 0),
                description=v.get("description", {}).get("text"),
            ))
        return vulns

    def get_config_schema(self) -> dict:
        base = super().get_config_schema()
        base["properties"].update({
            "console_url": {"type": "string", "format": "uri", "description": "InsightVM Console URL"},
            "api_key": {"type": "string", "format": "password", "description": "API Key"},
            "username": {"type": "string", "description": "Username (if not using API key)"},
            "password": {"type": "string", "format": "password", "description": "Password"},
        })
        return base
