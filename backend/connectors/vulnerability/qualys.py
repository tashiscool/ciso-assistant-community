"""
Qualys Connector.

Provides cloud-based vulnerability management and compliance monitoring.
"""

from dataclasses import dataclass, field
from typing import Any, List, Optional
import logging
import httpx
import base64

from ..base.connector import (
    BaseConnector, ConnectorCategory, ConnectorConfig, ConnectorResult, AuthenticationError
)
from ..base.registry import ConnectorRegistry

logger = logging.getLogger(__name__)


@dataclass
class QualysVulnerability:
    """Represents a Qualys vulnerability finding."""
    id: str
    qid: str
    title: str
    severity: int
    type_name: str
    host_ip: str
    host_name: Optional[str]
    port: Optional[int]
    protocol: Optional[str]
    cve_ids: List[str] = field(default_factory=list)
    cvss_score: Optional[float] = None
    cvss_vector: Optional[str] = None
    pci_flag: bool = False
    description: Optional[str] = None
    solution: Optional[str] = None
    results: Optional[str] = None
    first_detected: Optional[str] = None
    last_detected: Optional[str] = None


@ConnectorRegistry.register
class QualysConnector(BaseConnector[QualysVulnerability]):
    """Connector for Qualys Cloud Platform."""

    connector_type = "qualys"
    display_name = "Qualys"
    description = "Cloud-based vulnerability management and compliance platform"
    category = ConnectorCategory.VULNERABILITY
    supported_auth_types = ["basic"]
    supports_sync = True
    supports_webhook = True

    def __init__(self, config: ConnectorConfig):
        super().__init__(config)
        self._auth_header: Optional[str] = None

    async def validate_config(self) -> ConnectorResult:
        required = ["username", "password", "api_url"]
        missing = [f for f in required if not self.config.credentials.get(f)]
        if missing:
            return ConnectorResult(success=False, error_message=f"Missing: {', '.join(missing)}", error_code="MISSING_CREDENTIALS")
        return ConnectorResult(success=True)

    async def test_connection(self) -> ConnectorResult:
        try:
            await self.authenticate()
            api_url = self.config.credentials["api_url"].rstrip("/")
            async with httpx.AsyncClient() as client:
                response = await client.get(
                    f"{api_url}/msp/about.php",
                    headers={"Authorization": self._auth_header, "X-Requested-With": "Python"},
                    timeout=self.config.timeout_seconds
                )
                if response.status_code == 200:
                    return ConnectorResult(success=True)
            return ConnectorResult(success=False, error_message="API connection failed", error_code="CONNECTION_ERROR")
        except Exception as e:
            return ConnectorResult(success=False, error_message=str(e), error_code="CONNECTION_ERROR")

    async def authenticate(self) -> ConnectorResult:
        username = self.config.credentials.get("username")
        password = self.config.credentials.get("password")
        if not username or not password:
            raise AuthenticationError("Username and password required")
        creds = base64.b64encode(f"{username}:{password}".encode()).decode()
        self._auth_header = f"Basic {creds}"
        return ConnectorResult(success=True)

    async def fetch_data(self, **kwargs) -> ConnectorResult:
        if not self._auth_header:
            return ConnectorResult(success=False, error_message="Not authenticated", error_code="NOT_AUTHENTICATED")

        api_url = self.config.credentials["api_url"].rstrip("/")
        all_vulns = []

        try:
            async with httpx.AsyncClient() as client:
                headers = {
                    "Authorization": self._auth_header,
                    "X-Requested-With": "Python",
                    "Content-Type": "application/x-www-form-urlencoded"
                }

                # Get host detections
                params = {
                    "action": "list",
                    "show_igs": "1",
                    "show_results": "1",
                    "output_format": "JSON",
                }

                if kwargs.get("severity_filter"):
                    params["severities"] = kwargs["severity_filter"]

                response = await client.post(
                    f"{api_url}/api/2.0/fo/asset/host/vm/detection/",
                    headers=headers,
                    data=params,
                    timeout=self.config.timeout_seconds * 3
                )

                if response.status_code == 200:
                    # Parse XML/JSON response
                    try:
                        data = response.json()
                        hosts = data.get("HOST_LIST_VM_DETECTION_OUTPUT", {}).get("RESPONSE", {}).get("HOST_LIST", {}).get("HOST", [])
                        if isinstance(hosts, dict):
                            hosts = [hosts]

                        for host in hosts:
                            detections = host.get("DETECTION_LIST", {}).get("DETECTION", [])
                            if isinstance(detections, dict):
                                detections = [detections]
                            for det in detections:
                                det["_host_ip"] = host.get("IP")
                                det["_host_name"] = host.get("DNS")
                                all_vulns.append(det)
                    except Exception:
                        pass

            return ConnectorResult(success=True, data=all_vulns, items_processed=len(all_vulns))
        except Exception as e:
            return ConnectorResult(success=False, error_message=str(e), error_code="FETCH_ERROR")

    async def transform_data(self, raw_data: Any) -> List[QualysVulnerability]:
        vulns = []
        for v in raw_data:
            vulns.append(QualysVulnerability(
                id=f"{v.get('_host_ip', '')}:{v.get('QID', '')}",
                qid=str(v.get("QID", "")),
                title=v.get("TYPE", "Unknown"),
                severity=int(v.get("SEVERITY", 0)),
                type_name=v.get("TYPE", ""),
                host_ip=v.get("_host_ip", ""),
                host_name=v.get("_host_name"),
                port=int(v.get("PORT", 0)) if v.get("PORT") else None,
                protocol=v.get("PROTOCOL"),
                pci_flag=v.get("PCI_FLAG") == "1",
                results=v.get("RESULTS"),
                first_detected=v.get("FIRST_FOUND_DATETIME"),
                last_detected=v.get("LAST_FOUND_DATETIME"),
            ))
        return vulns

    def get_config_schema(self) -> dict:
        base = super().get_config_schema()
        base["properties"].update({
            "username": {"type": "string", "description": "Qualys Username"},
            "password": {"type": "string", "format": "password", "description": "Qualys Password"},
            "api_url": {"type": "string", "format": "uri", "description": "Qualys API URL (e.g., https://qualysapi.qualys.com)"},
        })
        base["required"].extend(["username", "password", "api_url"])
        return base
